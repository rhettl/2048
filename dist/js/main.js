angular.module("2048Game",["cfp.hotkeys"]),angular.module("2048Game").controller("fieldCtrl",["$scope","FieldMatrix","hotkeys",function(t,i,n){"use strict";t.winningNumber=32,t.field=new i({winningNumber:t.winningNumber}),t.add=function(){t.field.addRandomNumber()},t.reset=function(){t.field.win&&(t.winningNumber+=t.winningNumber),t.field=new i({winningNumber:t.winningNumber})};var e=[{combo:"enter",callback:function(i){i.preventDefault(),t.field.playable||t.reset()}},{combo:"down",description:"Slide Tiles Down",callback:function(i){i.preventDefault(),t.field.slide("down")}},{combo:"up",description:"Slide Tiles Up",callback:function(i){i.preventDefault(),t.field.slide("up")}},{combo:"right",description:"Slide Tiles Right",callback:function(i){i.preventDefault(),t.field.slide("right")}},{combo:"left",description:"Slide Tiles Left",callback:function(i){i.preventDefault(),t.field.slide("left")}}];e.forEach(function(t){n.add(t)})}]),angular.module("2048Game").directive("tile",["$parse",function(t){"use strict";var i=function(t,i){for(var n=[],e=0;e<t.length;e++)n.push(Math.floor(t[e]*i[e]/255));return n},n=function(t){var i=t.match(/[0-9a-fA-F]/);return 3===i.length&&(i=[i[0],i[0],i[1],i[1],i[2],i[2]]),6===i.length?[i[0]+i[1],i[2]+i[3],i[4]+i[5]].map(function(t){return parseInt(t,16)}):[255,255,255]},e=function(t){return"#"+t.map(function(t){return t.toString(16)}).join("")};return{restrict:"A",replace:!0,link:function(r,a,l){var o=t(l.tile),s=o(r),u=t(l.winningNumber),h=u(r)||2048,c=n(r.$eval(l.baseColor)||"#ed9c28"),f=function(t){var n=255*Math.abs(t/h-1);a.css({"background-color":e(i(c,[n,n,n]))})};r.$watch(function(){var t=o(r);t!==s&&(h=u(r)||2048,s=t,f(t))}),f(s)}}}]),angular.module("2048Game").factory("FieldMatrix",[function(){"use strict";var t={rows:4,cols:4,tilesAtInit:2,insertableNumbers:[2,4],winningNumber:2048},i=function(i){this.$options=angular.extend({},t,i),this.lose=!1,this.win=!1,this.playable=!0,this.matrix=this.newMatrix(this.$options.rows,this.$options.cols);for(var n=0;n<this.$options.tilesAtInit;n++)this.addRandomNumber()},n={newMatrix:function(t,i){for(var n=[],e=0;t>e;e++)for(var r=0;i>r;r++)n[e]||(n[e]=[]),n[e][r]=null;return n},getRandomAvailableTile:function(){var t=[];return this.matrix.forEach(function(i,n){i.forEach(function(i,e){null===i&&t.push([n,e])})}),t.length?this.randomArrayElem(t):!1},randomArrayElem:function(t){return t[Math.floor(Math.random()*t.length)]},insertNumber:function(t,i){return t?this.matrix[t[0]][t[1]]=i:!1},addRandomNumber:function(){return this.insertNumber(this.getRandomAvailableTile(),this.randomArrayElem(this.$options.insertableNumbers))},isSame:function(t,i){if(t.length!==i.length)return!1;var n=!0;return t.forEach(function(t,e){return void 0===typeof i[e]||i[e].length!==t.length?(n=!1,!1):(t.forEach(function(t,r){return void 0===typeof i[e][r]||t!==i[e][r]?(n=!1,!1):void 0}),n?void 0:!1)}),n},hasEmptyTiles:function(){for(var t=0;t<this.matrix.length;t++)for(var i=0;i<this.matrix[t].length;i++)if(null===this.matrix[t][i])return!0;return!1},hasSameAdjacent:function(){for(var t=0;t<this.matrix.length;t++)for(var i=0;i<this.matrix[t].length;i++)if(t+1<this.matrix.length&&this.matrix[t+1][i]===this.matrix[t][i]||t>0&&this.matrix[t-1][i]===this.matrix[t][i]||i+1<this.matrix.length&&this.matrix[t][i+1]===this.matrix[t][i]||i>0&&this.matrix[t][i-1]===this.matrix[t][i])return!0;return!1},canPlayOn:function(){return this.hasEmptyTiles()||this.hasSameAdjacent()},checkWin:function(){for(var t=0;t<this.matrix.length;t++)for(var i=0;i<this.matrix[t].length;i++)if(this.matrix[t][i]>=this.$options.winningNumber)return this.win=!0,this.playable=!1,!0;return!1},slide:function(t){if(this.playable){for(var i="down"===t||"right"===t,n="up"===t||"down"===t,e=n===!0?this.matrix[0].length-1:this.matrix.length-1,r=angular.copy(this.matrix),a=e;a>=0;a--){for(var l=[],o=i?r.length-1:0,s=o;i?s>=0:s<r.length;i?s--:s++)n?null!==r[s][a]&&(l.push(r[s][a]),r[s][a]=null):null!==r[a][s]&&(l.push(r[a][s]),r[a][s]=null);for(var s=o,u=0;u<l.length;u++){var h;u+1<l.length&&l[u]===l[u+1]?(h=l[u]+l[u+1],u++):h=l[u],n?r[s][a]=h:r[a][s]=h,i?s--:s++}}var c=!this.isSame(r,this.matrix);this.matrix=r,!this.checkWin()&&c&&(this.addRandomNumber(),this.canPlayOn()||(this.lose=!0,this.playable=!1))}},slideDown:function(){this.slide("down")},slideUp:function(){this.slide("up")},slideLeft:function(){this.slide("left")},slideRight:function(){this.slide("right")}};return angular.extend(i.prototype,n),i}]);